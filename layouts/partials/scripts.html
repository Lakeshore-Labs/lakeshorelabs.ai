{{ $script := resources.Get "js/script.js" }}
{{ if hugo.IsProduction }}
    {{ $script = $script | minify | fingerprint }}
{{ end }}
<script src="{{ $script.RelPermalink }}"{{ if hugo.IsProduction }} integrity="{{ $script.Data.Integrity }}"{{ end }}></script>

<!-- Blog-specific JavaScript -->
{{ if or (eq .Section "posts") (in .RelPermalink "/posts/") }}
{{ $blogScript := resources.Get "js/blog.js" }}
{{ if hugo.IsProduction }}
    {{ $blogScript = $blogScript | minify | fingerprint }}
{{ end }}
<script src="{{ $blogScript.RelPermalink }}"{{ if hugo.IsProduction }} integrity="{{ $blogScript.Data.Integrity }}"{{ end }}></script>
{{ end }}

<!-- GLightbox for blog posts -->
{{ if or (eq .Section "posts") (in .RelPermalink "/posts/") }}
<script src="/js/glightbox.min.js"></script>
{{ end }}

<!-- Mermaid initialization if needed -->
{{ if .Store.Get "hasMermaid" }}
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    
    // Initialize Mermaid
    mermaid.initialize({ 
        startOnLoad: true,
        theme: 'dark',
        themeVariables: {
            primaryColor: '#a891d1',
            primaryTextColor: '#f1f1f1',
            primaryBorderColor: '#7877c6',
            lineColor: '#9381be',
            secondaryColor: '#7877c6',
            tertiaryColor: '#10101b',
            background: 'rgba(16, 16, 27, 0.8)',
            mainBkg: 'rgba(16, 16, 27, 0.8)',
            secondBkg: 'rgba(120, 119, 198, 0.1)',
            tertiaryBkg: 'rgba(168, 145, 209, 0.1)',
            primaryBorderColor: 'rgba(168, 145, 209, 0.3)',
            lineColor: 'rgba(168, 145, 209, 0.5)',
            textColor: '#f1f1f1',
            nodeTextColor: '#f1f1f1',
            fontSize: '16px',
            fontFamily: 'Inter, system-ui, sans-serif',
            nodeBkg: 'rgba(120, 119, 198, 0.2)',
            nodeBorder: 'rgba(168, 145, 209, 0.5)',
            clusterBkg: 'rgba(147, 129, 190, 0.1)',
            clusterBorder: 'rgba(168, 145, 209, 0.3)',
            defaultLinkColor: 'rgba(168, 145, 209, 0.5)',
            titleColor: '#f1f1f1',
            edgeLabelBackground: 'rgba(16, 16, 27, 0.9)',
            actorBkg: 'rgba(120, 119, 198, 0.2)',
            actorBorder: 'rgba(168, 145, 209, 0.5)',
            actorTextColor: '#f1f1f1',
            actorLineColor: 'rgba(168, 145, 209, 0.5)',
            signalColor: '#f1f1f1',
            signalTextColor: '#f1f1f1',
            labelBoxBkgColor: 'rgba(120, 119, 198, 0.2)',
            labelBoxBorderColor: 'rgba(168, 145, 209, 0.5)',
            labelTextColor: '#f1f1f1',
            loopTextColor: '#f1f1f1',
            activationBorderColor: 'rgba(168, 145, 209, 0.5)',
            activationBkgColor: 'rgba(120, 119, 198, 0.2)',
            sequenceNumberColor: '#f1f1f1'
        }
    });
    
    // After Mermaid renders, make diagrams clickable
    window.addEventListener('load', function() {
        setTimeout(() => {
            const diagrams = document.querySelectorAll('pre.mermaid');
            const lightboxItems = [];
            
            diagrams.forEach((diagram, index) => {
                // Add click cursor
                diagram.style.cursor = 'zoom-in';
                
                // Create a full-size version for the lightbox
                const svgElement = diagram.querySelector('svg');
                if (svgElement) {
                    // Clone the SVG for the lightbox
                    const svgClone = svgElement.cloneNode(true);
                    svgClone.style.maxWidth = '90vw';
                    svgClone.style.maxHeight = '90vh';
                    svgClone.style.width = 'auto';
                    svgClone.style.height = 'auto';
                    
                    // Get diagram title from nearby heading
                    const prevElement = diagram.parentElement.previousElementSibling;
                    const title = prevElement && prevElement.tagName.match(/^H[1-6]$/) 
                        ? prevElement.textContent 
                        : 'Diagram ' + (index + 1);
                    
                    // Create lightbox item
                    lightboxItems.push({
                        content: svgClone.outerHTML,
                        type: 'inline',
                        width: '90vw',
                        height: '90vh'
                    });
                    
                    // Add click handler
                    diagram.addEventListener('click', () => {
                        const lightbox = GLightbox({
                            elements: [lightboxItems[index]],
                            closeButton: true,
                            closeOnOutsideClick: true,
                            cssEfects: {
                                fadeIn: true,
                                fadeOut: true
                            }
                        });
                        lightbox.open();
                    });
                    
                    // Add hover effect
                    diagram.addEventListener('mouseenter', () => {
                        diagram.style.transform = 'scale(1.02)';
                        diagram.style.transition = 'transform 0.3s ease';
                    });
                    
                    diagram.addEventListener('mouseleave', () => {
                        diagram.style.transform = 'scale(1)';
                    });
                }
            });
        }, 1000); // Wait for Mermaid to render
    });
  </script>
{{ end }}

<!-- Initialize Feather Icons -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        feather.replace();
    });
</script>